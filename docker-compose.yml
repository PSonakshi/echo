version: "3.8"

services:
  # Main Pathway Pipeline
  pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crypto-pulse-pipeline
    ports:
      - "${PIPELINE_PORT:-8000}:8000"
      - "${WEBHOOK_PORT:-8080}:8080"
    environment:
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TELEGRAM_CHANNEL_ID=${TELEGRAM_CHANNEL_ID}
      - TRACKED_COIN=${TRACKED_COIN:-MEME}
      - COINGECKO_API_KEY=${COINGECKO_API_KEY:-}
      - OLLAMA_HOST=http://ollama:11434
      - LLM_MODEL=${LLM_MODEL:-ollama/mistral}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-avsolatorio/GIST-small-Embedding-v0}
    volumes:
      - ./data:/app/data
      - ./Cache:/app/Cache
    depends_on:
      - ollama
    restart: unless-stopped
    networks:
      - crypto-pulse-network

  # Telegram Bot Service
  telegram-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crypto-pulse-telegram
    command: python -m bot.telegram_bot
    environment:
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TELEGRAM_CHANNEL_ID=${TELEGRAM_CHANNEL_ID}
      - TRACKED_COIN=${TRACKED_COIN:-MEME}
      - PIPELINE_HOST=pipeline
      - PIPELINE_PORT=8000
    depends_on:
      - pipeline
    restart: unless-stopped
    networks:
      - crypto-pulse-network

  # Streamlit Dashboard
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crypto-pulse-dashboard
    command: streamlit run dashboard/streamlit_app.py --server.port=8501 --server.address=0.0.0.0
    ports:
      - "${DASHBOARD_PORT:-8501}:8501"
    environment:
      - PIPELINE_HOST=pipeline
      - PIPELINE_PORT=8000
      - TRACKED_COIN=${TRACKED_COIN:-MEME}
    depends_on:
      - pipeline
    restart: unless-stopped
    networks:
      - crypto-pulse-network

  # Hype Simulator (for demos)
  simulator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crypto-pulse-simulator
    command: python -m simulator.hype_simulator
    environment:
      - WEBHOOK_URL=http://pipeline:8080/messages
      - TRACKED_COIN=${TRACKED_COIN:-MEME}
      - SIMULATOR_DURATION_MINS=${SIMULATOR_DURATION_MINS:-3.0}
      - SIMULATOR_MESSAGE_COUNT=${SIMULATOR_MESSAGE_COUNT:-200}
    depends_on:
      - pipeline
    profiles:
      - demo
    networks:
      - crypto-pulse-network

  # Ollama LLM Service
  ollama:
    image: ollama/ollama:latest
    container_name: crypto-pulse-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    restart: unless-stopped
    networks:
      - crypto-pulse-network

networks:
  crypto-pulse-network:
    driver: bridge

volumes:
  ollama-data:
